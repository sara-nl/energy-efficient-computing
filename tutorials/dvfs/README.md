# Dynamic frequency scaling (DVFS)

Dynamic frequency scaling (also known as CPU throttling) is a power management technique in computer architecture whereby the frequency of a microprocessor can be automatically adjusted "on the fly" depending on the actual needs, to conserve power and reduce the amount of heat generated by the chip (wikipedia https://en.wikipedia.org/wiki/Dynamic_frequency_scaling). 

![GOALZ1](../../images/PETvFreq_MM_GROMACS_HEMEL_v2.png)


# How to do it on Snellius

Since Snellius is a shared public machine. It is not so easy to change CPU Freqs dynamically. So we will achieve this via the EAR daemon (which is running on all of the nodes)

```
#!/bin/bash

#SBATCH -p thin
#SBATCH -n 128
#SBATCH -t 00:30:00
#SBATCH --exclusive 
#SBATCH --constraint=hwperf
#SBATCH --output=job_example.out
#SBATCH --error=job_example.err

#SBATCH --ear=on

module load 2022
module load foss/2022a
module load pmt/1.1.0-GCCcore-11.3.0

srun --ntasks=1 --ear-cpufreq=1500000 --ear-policy=monitoring --ear-verbose=1 ./executable
```
NOTE THE.... 
```
srun --ntasks=1 --ear-cpufreq=1500000 --ear-policy=monitoring --ear-verbose=1`
```

# Hands-on sessions


## 1. Can you reduce the Energy footprint of Matrix Multiplication (10000x10000) @ 128 OpenMP threads?

- Can you reduce this by 10%?

- Helpful scripts!
    
    Jobscript
    ```
    dvfs_sbatch_example_1.sh
    ```
    >This will output a AMDuProf_output_power_freq_$NUM/ directory for each freq that was used.

    Plotting script

    ```
    python ../scripts/plot_AMD_csv.py AMDuProf_output_power_freq_1500000/AMDuProf-mat_mul-Timechart_May-30-2023_16-01-36/timechart.csv
    ```
    This will produce a png of the results `timechart_plot.png`, in the `AMDuProf_output_power_freq_1500000/AMDuProf-mat_mul-Timechart_May-30-2023_16-01-36/` for example.

## 2. How does the Power scale with Frequency of an AMD EPYC 7H12 64-Core Processor?

- Can you reproduce Power-Frequency Relationship for the AMD ROME nodes of Snellius?
    - You will likely have to probe this with `mat_mut` or `saxpy` or your own more sophisticated code!
- Helpful scripts!
    
    Jobscript
    ```
    dvfs_sbatch_example_2.sh
    ```
    >This will output a results_freq_FREQNUM.txt file for each freq that was used.

    Plotting script

    ```
    python ../scripts/plot_dvfs_example_2.py results_freq_*
    ```
    This will produce a png of the results `dvfs_example_2.png`




